<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Street Bites Manila</title>
    <script src="script.js" defer></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="sidebar" id="sidebar">
        <button onclick="toggleSidebar()">‚ò∞</button>
        <ul>
            <li>Adidas (Chicken Feet)</li>
            <li>Atay</li>
            <li>Balut</li>
            <li>Banana cue</li>
            <li>BBQ</li>
            <li>Betamax</li>
            <li>Fishball</li>
            <li>Fresh lumpia</li>
            <li>Halo-halo</li>
            <li>Helmet (Chicken Head)</li>
            <li>Isaw</li>
            <li>Kikiam</li>
            <li>Kwek-kwek</li>
            <li>Lomi</li>
            <li>Lugaw</li>
            <li>Mangga w/ Bagoong</li>
            <li>Okoy</li>
            <li>Pares</li>
            <li>Proben</li>
            <li>Siomai</li>
            <li>Squidball</li>
            <li>Taho</li>
            <li>Turon</li>
            <li>Veggy balls</li>
        </ul>
    </div>

    <div class="main-content">
        <header>
            <h1 onclick="location.href='Street_Bites_Manila.html'">Street Bites Manila</h1>
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="Enter Business Name...">
                <button id="search-button">Search</button>
            </div>
            
            <nav>
                <ul>
                    <li><a href="#home">Home</a></li>
                    <li><a href="#find-stalls">Find Stalls</a></li>
                    <li><a href="#reviews">Reviews</a></li>
                    <li><a href="#signup">Vendor Sign-Up</a></li>
                    <li><a href="#contact" onclick="location.href='contact.html'">Contact</a></li>
                </ul>
            </nav>
        </header>

        <main>
            <section id="home">
                <h2>Find the Best Street Food in Manila!</h2>
            
                <div id="streetfood-icons">
                    <div class="food-item" onclick="filterVendorsByFood('Isaw')">
                        <a href="#find-stalls">
                        <img src="streetfood-icons/isaw.png" alt="Isaw">
                        </a>
                        <p>Isaw</p>
                    </div>
                    <div class="food-item" onclick="filterVendorsByFood('Fishball')">
                        <a href="#find-stalls">
                        <img src="streetfood-icons/fishball.png" alt="Fishball">
                        </a>
                        <p>Fishball</p>
                    </div>
                    <div class="food-item" onclick="filterVendorsByFood('Kwek-Kwek')">
                        <a href="#find-stalls">
                        <img src="streetfood-icons/kwek-kwek.png" alt="Kwek-kwek">
                        </a>
                        <p>Kwek-Kwek</p>
                    </div>
                    <div class="food-item" onclick="filterVendorsByFood('Kikiam')">
                        <a href="#find-stalls">
                        <img src="streetfood-icons/kikiam.png" alt="Kikiam">
                        </a>
                        <p>Kikiam</p>
                    </div>
                    <div class="food-item" onclick="filterVendorsByFood('Pork BBQ')">
                        <a href="#find-stalls">
                        <img src="streetfood-icons/pork-bbq.png" alt="Pork BBQ">
                        </a>
                        <p>Pork Barbeque</p>
                    </div>
                    <div class="food-item" onclick="filterVendorsByFood('Calamares')">
                        <a href="#find-stalls">
                        <img src="streetfood-icons/calamares.png" alt="Calamares">
                        </a>
                        <p>Calamares</p>
                    </div>
                    <div class="food-item" onclick="filterVendorsByFood('Bananaque')">
                        <a href="#find-stalls">
                        <img src="streetfood-icons/bananaque.png" alt="Bananaque">
                        </a>
                        <p>Bananaque</p>
                    </div>
                    <div class="food-item" onclick="filterVendorsByFood('Squidball')">
                        <a href="#find-stalls">
                        <img src="streetfood-icons/squidball.png" alt="Squidball">
                        </a>
                        <p>Squidball</p>
                    </div>
                </div>
            </section>
            
            <section id="find-stalls">
                <h2>Food Stall Finder</h2>
                <p>Browse stalls on our interactive map.</p>
                <div id="map"></div>
            </section>

            <section id="reviews">
                <h2>Customer Reviews</h2>
                <p>See what others are saying about their favorite street food spots.</p>
                <ul id="reviews-list"></ul>
                <button onclick="location.href='reviews.html'">Leave a Review!</button>
            </section>

            <section id="signup">
                <h2>Vendor Sign-Up</h2>
                <p>Register your food stall to reach more customers!</p>
                <button class="vendor-signup" onclick="location.href='vendor-signup.html'">Sign Up</button>
            </section>
        </main>

        <footer>
            <p>&copy; 2025 Street Bites Manila | All Rights Reserved</p>
        </footer>
    </div>

    <script>
        function toggleSidebar() {
        var sidebar = document.getElementById("sidebar");
        sidebar.classList.toggle("expanded");
        }
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDWwZaheI8E8zXhuQFIkdcHDkq_x265FuU&callback=initMap" async defer></script>

    <script>
        let map;

        function initMap() {
    console.log("üåç Initializing Google Map...");
    
    // Ensure map is globally accessible
    window.map = new google.maps.Map(document.getElementById("map"), {
        zoom: 12,
        center: { lat: 14.5995, lng: 120.9842 } // Default Manila
    });

    console.log("‚úÖ Google Map initialized:", window.map);
    }
    </script>

    <script>
        function filterVendorsByFood(food) {
            console.log("Filtering vendors for:", food);

            // Scroll to the map section smoothly
            document.getElementById("map").scrollIntoView({ behavior: "smooth" });

            // You can also add your vendor filtering logic here
        }
    </script>

    <script type="module">
        import { db } from "./firebase-config.js";
        import { collection, getDocs,  } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";
    
        let vendorMarkers = []; // Store vendor markers
    
        function initMap() {
            window.map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 14.5995, lng: 120.9842 }, // Default Manila
                zoom: 12
            });
        }
    
        async function filterVendorsByFood(foodType) {
    let searchFood = foodType.trim(); // Ensure exact match
    console.log(`üîç Searching for vendors selling: "${searchFood}"`);

    // Ensure the map is initialized
    if (!window.map) {
        console.error("‚ùå Google Map is not initialized.");
        alert("Map is not loaded yet. Please try again.");
        return;
    }

    // Clear existing markers
    vendorMarkers.forEach(marker => marker.setMap(null));
    vendorMarkers = [];

    const querySnapshot = await getDocs(collection(db, "vendors"));
    let foundVendors = 0;
    let bounds = new google.maps.LatLngBounds();

    querySnapshot.forEach(doc => {
        let data = doc.data();
        console.log("üìå Fetched vendor data:", data);

        let vendorFood = data.specialty.trim(); // Ensure exact match

        // Convert latitude and longitude from string to number
        let lat = parseFloat(data.latitude);
        let lng = parseFloat(data.longitude);

        // Validate lat/lng before creating a marker
        if (isNaN(lat) || isNaN(lng)) {
            console.error(`‚ùå Invalid lat/lng values for ${data.name}:`, data.latitude, data.longitude);
            return;
        }

        if (vendorFood === searchFood) {
            foundVendors++;

            if (!window.map) {
    console.error("‚ùå Google Map is not initialized!");
    alert("Map is not loaded yet. Please refresh and try again.");
    return;
}

async function searchVendorByName() {
    let searchName = document.getElementById("search-input").value.trim().toLowerCase();

    if (searchName === "") {
        alert("Please enter a business name to search.");
        return;
    }

    console.log(`üîç Searching for vendor: "${searchName}"`);

    // Clear existing markers
    vendorMarkers.forEach(marker => marker.setMap(null));
    vendorMarkers = [];

    const querySnapshot = await getDocs(collection(db, "vendors"));
    let vendorFound = false;

    querySnapshot.forEach(doc => {
        let data = doc.data();
        async function searchVendorByName() {
    let searchName = document.getElementById("search-input").value.trim().toLowerCase().replace(/\s+/g, "");
    
    if (searchName === "") {
        alert("Please enter a business name to search.");
        return;
    }

    console.log(`üîç Searching for vendor: "${searchName}"`);

    // Clear existing markers
    vendorMarkers.forEach(marker => marker.setMap(null));
    vendorMarkers = [];

    const querySnapshot = await getDocs(collection(db, "vendors"));
    let vendorFound = false;

    querySnapshot.forEach(doc => {
        let data = doc.data();
        let vendorName = data.name.trim().toLowerCase().replace(/\s+/g, ""); // Remove spaces for better matching
        let lat = parseFloat(data.latitude);
        let lng = parseFloat(data.longitude);

        if (vendorName === searchName) {
            vendorFound = true;

            let marker = new google.maps.Marker({
                position: { lat, lng },
                map: window.map,
                title: data.name
            });

            vendorMarkers.push(marker);

            let infoWindow = new google.maps.InfoWindow({
                content: `<h3>${data.name}</h3>
                          <p>Location: ${data.location}</p>
                          <p>Specialty: ${data.specialty}</p>`
            });

            marker.addListener("click", () => infoWindow.open(window.map, marker));

            window.map.setCenter({ lat, lng });
            window.map.setZoom(15);
        }
    });

    if (!vendorFound) {
        console.warn(`‚ùå No vendor found with name: "${searchName}"`);
        alert(`No vendor found with the name "${searchName}".`);
    }
}

// Attach search function to button click
document.getElementById("search-button").addEventListener("click", searchVendorByName);

// Allow pressing "Enter" to trigger search
document.getElementById("search-input").addEventListener("keypress", function (event) {
    if (event.key === "Enter") {
        searchVendorByName();
    }
});

        let lat = parseFloat(data.latitude);
        let lng = parseFloat(data.longitude);

        if (vendorName === searchName) {
            vendorFound = true;

            let marker = new google.maps.Marker({
                position: { lat, lng },
                map: window.map,
                title: data.name
            });

            vendorMarkers.push(marker);

            let infoWindow = new google.maps.InfoWindow({
                content: `<h3>${data.name}</h3>
                          <p>Location: ${data.location}</p>
                          <p>Specialty: ${data.specialty}</p>`
            });

            marker.addListener("click", () => infoWindow.open(window.map, marker));

            window.map.setCenter({ lat, lng });
            window.map.setZoom(15);
        }
    });

    if (!vendorFound) {
        console.warn(`‚ùå No vendor found with name: "${searchName}"`);
        alert(`No vendor found with the name "${searchName}".`);
    }
}

// Attach search function to button click
document.getElementById("search-button").addEventListener("click", searchVendorByName);

// Allow pressing "Enter" to trigger search
document.getElementById("search-input").addEventListener("keypress", function (event) {
    if (event.key === "Enter") {
        searchVendorByName();
    }
});

let marker = new google.maps.Marker({
    position: { lat, lng },
    map: window.map, // Make sure map is available
    title: data.name
});


            vendorMarkers.push(marker);
            bounds.extend(marker.position);

            let infoWindow = new google.maps.InfoWindow({
                content: `<h3>${data.name}</h3><p>${data.location}</p>`
            });

            marker.addListener("click", () => infoWindow.open(window.map, marker));
        }
    });

    if (foundVendors > 0) {
        console.log(`‚úÖ Found ${foundVendors} vendors for "${searchFood}"`);
        window.map.fitBounds(bounds);
    } else {
        console.warn(`‚ùå No vendors found for "${searchFood}"`);
        alert(`No vendors found for ${foodType}.`);
    }
}
    
        window.initMap = initMap;
        window.filterVendorsByFood = filterVendorsByFood;
    </script>

    <script type="module">
        import { db } from "./firebase-config.js";
import { collection, getDocs, onSnapshot, query, orderBy, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

async function loadVendors() {
    const vendorList = document.getElementById("vendor-list");  // List
    const vendorSelect = document.getElementById("vendor-list");  // Dropdown

    vendorList.innerHTML = "<option>Loading vendors...</option>";
    vendorSelect.innerHTML = `<option value="">-- Select a Vendor --</option>`;

    try {
        const querySnapshot = await getDocs(collection(db, "vendors"));
        vendorList.innerHTML = "";

        querySnapshot.forEach((doc) => {
            let vendorData = doc.data();
            console.log("Fetched Vendor:", vendorData);

            // Add to List
            let li = document.createElement("li");
            li.textContent = vendorData.name;
            vendorList.appendChild(li);

            // Add to Dropdown
            let option = document.createElement("option");
            option.value = vendorData.name;
            option.textContent = vendorData.name;
            vendorSelect.appendChild(option);
        });

        if (!vendorList.hasChildNodes()) {
            vendorList.innerHTML = "<option>No vendors found.</option>";
        }
    } catch (error) {
        console.error("Error loading vendors:", error);
        vendorList.innerHTML = "<option>Error loading vendors.</option>";
    }
}


// Call the function when the page loads
document.addEventListener("DOMContentLoaded", loadVendors);


function loadReviews() {
    const reviewsList = document.getElementById("reviews-list");
    reviewsList.innerHTML = "<li>Loading reviews...</li>";

    const q = query(collection(db, "reviews"), orderBy("timestamp", "desc"));

    onSnapshot(q, (snapshot) => {
        reviewsList.innerHTML = ""; // Clear existing reviews

        snapshot.forEach((doc) => {
            let data = doc.data();
            let customerName = data.customerName || "Anonymous"; // Default if missing
            let reviewText = data.reviewText || "No review provided";
            let rating = data.rating || "0"; // Default rating if missing

            let li = document.createElement("li");
            li.innerHTML = `<strong>${customerName}</strong>: ${reviewText} (‚≠ê${rating})`;
            reviewsList.appendChild(li);
        });

        if (reviewsList.innerHTML === "") {
            reviewsList.innerHTML = "<option>No reviews yet.</option>";
        }
    });
}

// Call the function when the homepage loads
document.addEventListener("DOMContentLoaded", loadReviews);


// Function to handle review submission
document.addEventListener("DOMContentLoaded", function () {
    loadVendors();  // Load vendors when page loads

    document.getElementById("review-form").addEventListener("submit", async function (event) {
        event.preventDefault();

        let customerName = document.getElementById("customer-name").value.trim();
        let reviewText = document.getElementById("review-text").value.trim();
        let rating = document.getElementById("star-rating").value;
        let vendor = document.getElementById("vendor-list").value;

        if (!customerName || !reviewText || !rating || !vendor) {
            alert("Please fill in all fields.");
            return;
        }

        try {
            await addDoc(collection(db, "reviews"), {
                customerName,
                vendor,
                reviewText,
                rating,
                timestamp: serverTimestamp()
            });

            alert("Review submitted successfully!");
            document.getElementById("review-form").reset();
        } catch (error) {
            console.error("Error adding review: ", error);
            alert("Error: " + error.message);
        }
    });
});

    </script>
</body>
</html>
